version: "3.9"

services:
  apurement-api:
    image: babaly/apurement-api:${APUREMENT_VERSION:-latest}
    container_name: apurement-api
    restart: unless-stopped
    ports:
      - "3100:3000" # Expose on port 3100 to avoid conflicts
    networks:
      - apurement-network
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=${APUREMENT_DATABASE_URL}
      - DIRECT_URL=${APUREMENT_DIRECT_URL}
      - JWT_SECRET=${JWT_SECRET}
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
      - AZURE_STORAGE_CONTAINER_NAME=${AZURE_APUREMENT_STORAGE_CONTAINER_NAME:-apurement-documents}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M

  # Optional: Traefik for this project only
  traefik-apurement:
    image: traefik:v2.10
    container_name: traefik-apurement
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=apurement-network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@ameenaltech.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "8090:80" # HTTP on port 8090 (to avoid conflict with existing services)
      - "8443:443" # HTTPS on port 8443
      - "8889:8080" # Dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "${TRAEFIK_DATA_DIR:-./traefik}/letsencrypt:/letsencrypt"
    networks:
      - apurement-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik-apurement.ameenaltech.com`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
    profiles:
      - with-traefik # Only starts if specified

  apurement-api-with-traefik:
    image: babaly/apurement-api:${APUREMENT_VERSION:-latest}
    container_name: apurement-api-traefik
    restart: unless-stopped
    networks:
      - apurement-network
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=${APUREMENT_DATABASE_URL}
      - DIRECT_URL=${APUREMENT_DIRECT_URL}
      - JWT_SECRET=${JWT_SECRET}
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
      - AZURE_STORAGE_CONTAINER_NAME=${AZURE_APUREMENT_STORAGE_CONTAINER_NAME:-apurement-documents}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.apurement.rule=Host(`api-apurement.ameenaltech.com`)"
      - "traefik.http.routers.apurement.entrypoints=websecure"
      - "traefik.http.routers.apurement.tls.certresolver=letsencrypt"
      - "traefik.http.services.apurement.loadbalancer.server.port=3000"
      - "traefik.http.services.apurement.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.apurement.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.middlewares.apurement-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE,PATCH"
      - "traefik.http.middlewares.apurement-cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.routers.apurement.middlewares=apurement-cors"
    profiles:
      - with-traefik # Only starts if specified

networks:
  apurement-network:
    name: apurement-network
    driver: bridge
