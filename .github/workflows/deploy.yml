name: Deploy Apurement API

on:
    push:
        branches: [main, production]
    workflow_dispatch:

permissions:
    contents: read
    packages: write
    security-events: write
    actions: read

env:
    REGISTRY: docker.io
    IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/apurement-api

jobs:
    build:
        name: Build Docker Image
        runs-on: ubuntu-latest

        outputs:
            image-tag: ${{ steps.vars.outputs.docker-tag }}
            short-sha: ${{ steps.vars.outputs.short-sha }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set variables
              id: vars
              run: |
                  echo "short-sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
                  echo "docker-tag=main-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      BUILDKIT_INLINE_CACHE=1

    deploy:
        name: Deploy to Server
        needs: build
        runs-on: ubuntu-latest
        environment: production

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.0
              env:
                  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
                  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
                  IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
                  GIT_COMMIT: ${{ github.sha }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.SERVER_PORT || 22 }}
                  envs: DOCKER_USERNAME,DOCKER_PASSWORD,IMAGE_TAG,GIT_COMMIT,GITHUB_REPOSITORY
                  script_stop: true
                  timeout: 300s
                  script: |
                      # Download and execute deployment script
                      mkdir -p /opt/apurement/scripts

                      curl -fsSL "https://raw.githubusercontent.com/$GITHUB_REPOSITORY/main/scripts/deploy.sh" \
                        -o /opt/apurement/scripts/deploy.sh

                      chmod +x /opt/apurement/scripts/deploy.sh

                      # Run deployment
                      /opt/apurement/scripts/deploy.sh

            - name: Verify deployment
              if: success()
              run: |
                  echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Service:** apurement-api" >> $GITHUB_STEP_SUMMARY
                  echo "**Image:** ${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "**URL:** https://api-apurement.ameenaltech.com" >> $GITHUB_STEP_SUMMARY

            - name: Rollback notification
              if: failure()
              run: |
                  echo "### ‚ùå Deployment Failed & Rolled Back" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Previous version has been restored automatically." >> $GITHUB_STEP_SUMMARY
                  echo "Check deployment logs for details." >> $GITHUB_STEP_SUMMARY

    notify-success:
        name: Notify Deployment Success
        needs: [build, deploy]
        if: success()
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Get commit info
              id: commit
              run: |
                  echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
                  echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
                  echo "date=$(git log -1 --pretty=format:'%ci')" >> $GITHUB_OUTPUT

            - name: Send success email
              uses: dawidd6/action-send-mail@v3
              with:
                  server_address: ${{ secrets.SMTP_HOST }}
                  server_port: ${{ secrets.SMTP_PORT }}
                  secure: ${{ secrets.SMTP_SECURE }}
                  username: ${{ secrets.SMTP_USER }}
                  password: ${{ secrets.SMTP_PASS }}
                  subject: '‚úÖ D√©ploiement r√©ussi - Apurement API'
                  to: ${{ secrets.DEV_FRONTEND_EMAIL }},${{ secrets.DEV_BACKEND_EMAIL }}
                  from: ${{ secrets.SMTP_FROM }}
                  html_body: |
                      <!DOCTYPE html>
                      <html>
                      <head>
                          <style>
                              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                              .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                              .header { background-color: #4CAF50; color: white; padding: 20px; text-align: center; border-radius: 5px 5px 0 0; }
                              .content { background-color: #f9f9f9; padding: 30px; border: 1px solid #ddd; border-radius: 0 0 5px 5px; }
                              .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                              .info-table td { padding: 10px; border-bottom: 1px solid #ddd; }
                              .info-table td:first-child { font-weight: bold; width: 150px; color: #555; }
                              .badge { display: inline-block; padding: 5px 10px; background-color: #4CAF50; color: white; border-radius: 3px; font-size: 12px; }
                              .footer { text-align: center; padding: 20px; font-size: 12px; color: #666; }
                          </style>
                      </head>
                      <body>
                          <div class="container">
                              <div class="header">
                                  <h1>‚úÖ D√©ploiement R√©ussi</h1>
                                  <p>Apurement API - Production</p>
                              </div>
                              <div class="content">
                                  <p>Le d√©ploiement de l'API Apurement a √©t√© effectu√© avec succ√®s.</p>

                                  <table class="info-table">
                                      <tr>
                                          <td>üîñ Branche</td>
                                          <td><span class="badge">${{ github.ref_name }}</span></td>
                                      </tr>
                                      <tr>
                                          <td>üìù Commit</td>
                                          <td>${{ steps.commit.outputs.message }}</td>
                                      </tr>
                                      <tr>
                                          <td>üë§ Auteur</td>
                                          <td>${{ steps.commit.outputs.author }}</td>
                                      </tr>
                                      <tr>
                                          <td>üìÖ Date</td>
                                          <td>${{ steps.commit.outputs.date }}</td>
                                      </tr>
                                      <tr>
                                          <td>üîë SHA Court</td>
                                          <td><code>${{ needs.build.outputs.short-sha }}</code></td>
                                      </tr>
                                      <tr>
                                          <td>üê≥ Image Docker</td>
                                          <td><code>${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}</code></td>
                                      </tr>
                                      <tr>
                                          <td>üåê URL API</td>
                                          <td><a href="https://api-apurement.ameenaltech.com">https://api-apurement.ameenaltech.com</a></td>
                                      </tr>
                                  </table>

                                  <p style="margin-top: 30px;">
                                      <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                                         style="display: inline-block; padding: 12px 30px; background-color: #2196F3; color: white; text-decoration: none; border-radius: 5px;">
                                          Voir les logs de d√©ploiement
                                      </a>
                                  </p>
                              </div>
                              <div class="footer">
                                  <p>Ce message a √©t√© envoy√© automatiquement par GitHub Actions</p>
                                  <p>Apurement - Syst√®me de Gestion des Douanes</p>
                              </div>
                          </div>
                      </body>
                      </html>

    notify-failure:
        name: Notify Deployment Failure
        needs: [build, deploy]
        if: failure()
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Get commit info
              id: commit
              run: |
                  echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
                  echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
                  echo "date=$(git log -1 --pretty=format:'%ci')" >> $GITHUB_OUTPUT

            - name: Send failure email
              uses: dawidd6/action-send-mail@v3
              with:
                  server_address: ${{ secrets.SMTP_HOST }}
                  server_port: ${{ secrets.SMTP_PORT }}
                  secure: ${{ secrets.SMTP_SECURE }}
                  username: ${{ secrets.SMTP_USER }}
                  password: ${{ secrets.SMTP_PASS }}
                  subject: '‚ùå √âchec du d√©ploiement - Apurement API'
                  to: ${{ secrets.DEV_BACKEND_EMAIL }}
                  from: ${{ secrets.SMTP_FROM }}
                  html_body: |
                      <!DOCTYPE html>
                      <html>
                      <head>
                          <style>
                              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                              .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                              .header { background-color: #f44336; color: white; padding: 20px; text-align: center; border-radius: 5px 5px 0 0; }
                              .content { background-color: #f9f9f9; padding: 30px; border: 1px solid #ddd; border-radius: 0 0 5px 5px; }
                              .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                              .info-table td { padding: 10px; border-bottom: 1px solid #ddd; }
                              .info-table td:first-child { font-weight: bold; width: 150px; color: #555; }
                              .badge { display: inline-block; padding: 5px 10px; background-color: #f44336; color: white; border-radius: 3px; font-size: 12px; }
                              .alert { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 3px; }
                              .footer { text-align: center; padding: 20px; font-size: 12px; color: #666; }
                          </style>
                      </head>
                      <body>
                          <div class="container">
                              <div class="header">
                                  <h1>‚ùå √âchec du D√©ploiement</h1>
                                  <p>Apurement API - Production</p>
                              </div>
                              <div class="content">
                                  <div class="alert">
                                      <strong>‚ö†Ô∏è Attention :</strong> Le d√©ploiement a √©chou√© et le syst√®me a effectu√© un rollback automatique vers la version pr√©c√©dente.
                                  </div>

                                  <table class="info-table">
                                      <tr>
                                          <td>üîñ Branche</td>
                                          <td><span class="badge">${{ github.ref_name }}</span></td>
                                      </tr>
                                      <tr>
                                          <td>üìù Commit</td>
                                          <td>${{ steps.commit.outputs.message }}</td>
                                      </tr>
                                      <tr>
                                          <td>üë§ Auteur</td>
                                          <td>${{ steps.commit.outputs.author }}</td>
                                      </tr>
                                      <tr>
                                          <td>üìÖ Date</td>
                                          <td>${{ steps.commit.outputs.date }}</td>
                                      </tr>
                                      <tr>
                                          <td>üîë SHA Court</td>
                                          <td><code>${{ needs.build.outputs.short-sha }}</code></td>
                                      </tr>
                                  </table>

                                  <p style="margin-top: 30px;">
                                      <strong>Action requise :</strong> Veuillez consulter les logs pour identifier et corriger le probl√®me.
                                  </p>

                                  <p style="margin-top: 20px;">
                                      <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                                         style="display: inline-block; padding: 12px 30px; background-color: #f44336; color: white; text-decoration: none; border-radius: 5px;">
                                          Consulter les logs d'erreur
                                      </a>
                                  </p>
                              </div>
                              <div class="footer">
                                  <p>Ce message a √©t√© envoy√© automatiquement par GitHub Actions</p>
                                  <p>Apurement - Syst√®me de Gestion des Douanes</p>
                              </div>
                          </div>
                      </body>
                      </html>
