generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Pooler for app runtime
  directUrl = env("DIRECT_URL") // Direct connection for migrations
}

enum UserRole {
  ADMIN
  AGENT
  SUPERVISEUR
  TRANSITAIRE
}

enum StatutApurement {
  APURE_SE
  APURE
  NON_APURE
  REJET
}

enum StatutOrdreMission {
  EN_COURS
  DEPOSE
  TRAITE
  REJETE
  ANNULE
}

enum TypeNotification {
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique @db.VarChar(100)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash")
  firstname    String    @map("first_name")
  lastname     String    @map("last_name")
  phone        String?
  role         UserRole
  isActive     Boolean?  @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLogin    DateTime? @map("last_login")
  deletedAt    DateTime? @map("deleted_at")

  declarations   Declaration[]
  colis          Colis[]
  maisonTransits MaisonTransit[]
  ordreMissions  OrdreMission[]
  auditLogs      AuditLog[]

  @@map("users")
}

model Regime {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  deletedAt DateTime?

  @@map("regimes")
}

model Escouade {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  description     String?   @db.Text
  operationalDate DateTime?
  chefId          Int?
  adjointId       Int?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  chef           Agent?           @relation("EscouadeChef", fields: [chefId], references: [id])
  adjoint        Agent?           @relation("EscouadeAdjoint", fields: [adjointId], references: [id])
  escouadeAgents EscouadeAgents[]
  agent          Agent?           @relation(fields: [agentId], references: [id])
  agentId        Int?

  @@map("escouades")
}

model Agent {
  id         Int       @id @default(autoincrement())
  matricule  String?   @unique
  grade      String?
  firstname  String    @map("first_name")
  lastname   String    @map("last_name")
  phone      String?
  email      String?
  affectedAt DateTime? @map("affected_at")
  officeId   Int?      @map("office_id")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  bureauAffectation  BureauSortie?    @relation(fields: [officeId], references: [id], onDelete: SetNull)
  declarations       Declaration[]
  escouadesAsChef    Escouade[]       @relation("EscouadeChef")
  escouadesAsAdjoint Escouade[]       @relation("EscouadeAdjoint")
  escouadeAgents     EscouadeAgents[]
  ordreMissions      OrdreMission[]
  escouades          Escouade[]

  @@map("agents")
}

model EscouadeAgents {
  escouadeId Int
  agentId    Int

  escouade Escouade @relation(fields: [escouadeId], references: [id])
  agent    Agent    @relation(fields: [agentId], references: [id])

  @@id([escouadeId, agentId])
  @@map("escouade_agents")
}

model BureauSortie {
  id            Int       @id @default(autoincrement())
  code          String    @unique
  name          String
  localisation  String?
  paysFrontiere String?   @map("pays_frontiere")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  declarations  Declaration[]
  agents        Agent[]
  ordreMissions OrdreMission[]

  @@map("bureaux_sorties")
}

model MaisonTransit {
  id            Int       @id @default(autoincrement())
  code          String    @unique
  name          String
  address       String?   @db.Text
  phone         String?
  email         String?
  responsableId Int?      @map("responsable_id")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  responsable   User?          @relation(fields: [responsableId], references: [id])
  depositaires  Depositaire[]
  declarations  Declaration[]
  ordreMissions OrdreMission[]

  @@map("maisons_transits")
}

model OrdreMission {
  id               Int                @id @default(autoincrement())
  number           Int                @unique @map("number")
  destination      String?
  itin√©raire      String?            @db.Text
  dateOrdre        DateTime?          @map("date_ordre")
  depositaireId    Int?               @map("depositaire_id")
  maisonTransitId  Int?               @map("maison_transit_id")
  createdById      Int?               @map("created_by")
  statut           StatutOrdreMission @default(EN_COURS)
  statutApurement  StatutApurement    @default(NON_APURE) @map("statut_apurement")
  agentEscorteurId Int?               @map("agent_escorteur_id")
  bureauSortieId   Int?               @map("bureau_sortie_id")
  observations     String?            @db.Text
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  deletedAt        DateTime?          @map("deleted_at")

  depositaire    Depositaire?   @relation(fields: [depositaireId], references: [id], onDelete: SetNull)
  createdBy      User?          @relation(fields: [createdById], references: [id])
  agentEscorteur Agent?         @relation(fields: [agentEscorteurId], references: [id], onDelete: SetNull)
  bureauSortie   BureauSortie?  @relation(fields: [bureauSortieId], references: [id], onDelete: SetNull)
  maisonTransit  MaisonTransit? @relation(fields: [maisonTransitId], references: [id], onDelete: SetNull)
  declarations   Declaration[]
  colis          Colis[]
  camions        Camion[]
  conteneurs     Conteneur[]
  voitures       Voiture[]

  @@map("ordres_missions")
}

model Depositaire {
  id                   Int       @id @default(autoincrement())
  name                 String
  phone1               String    @db.VarChar(20)
  phone2               String?
  address              String?   @db.Text
  email                String?
  identificationNumber String?   @map("identification_number")
  isActive             Boolean   @default(true) @map("is_active")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")

  savedDeclarations Declaration[]
  maisonTransit     MaisonTransit? @relation(fields: [maisonTransitId], references: [id])
  maisonTransitId   Int?
  ordreMissions     OrdreMission[]

  @@map("depositaires")
}

model Declaration {
  id                Int              @id @default(autoincrement())
  numeroDeclaration String           @unique @map("numero_declaration") @db.VarChar(50)
  dateDeclaration   DateTime         @map("date_declaration") @db.Date
  ordreMissionId    Int?             @map("ordre_mission_id")
  statutApurement   StatutApurement? @default(NON_APURE) @map("statut_apurement")
  dateApurement     DateTime?        @map("date_apurement") @db.Date
  motifRejet        String?          @map("motif_rejet") @db.Text
  bureauSortieId    Int?
  maisonTransitId   Int?
  depositaireId     Int?

  createdById Int?      @map("created_by")
  updatedById Int?      @map("updated_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  ordreMission  OrdreMission?  @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)
  createdBy     User?          @relation(fields: [createdById], references: [id], onDelete: SetNull)
  bureauSortie  BureauSortie?  @relation(fields: [bureauSortieId], references: [id])
  maisonTransit MaisonTransit? @relation(fields: [maisonTransitId], references: [id])
  depositaire   Depositaire?   @relation(fields: [depositaireId], references: [id])
  agent         Agent?         @relation(fields: [agentId], references: [id])
  agentId       Int?

  @@map("declarations")
}

model Colis {
  id                Int      @id @default(autoincrement())
  ordreMissionId    Int?     @map("ordre_mission_id")
  natureMarchandise String   @map("nature_marchandise") @db.Text
  positionTarifaire Int?     @map("position_tarifaire")
  poids             Decimal? @map("poids") @db.Decimal(12, 2)
  valeurDeclaree    Decimal? @map("valeur_declaree") @db.Decimal(15, 2)

  createdById Int?      @map("created_by")
  updatedById Int?      @map("updated_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  ordreMission OrdreMission? @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)
  createdBy    User?         @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@map("colis")
}

model Camion {
  id                Int       @id @default(autoincrement())
  ordreMissionId    Int?      @map("ordre_mission_id")
  immatriculation   String
  driverName        String?   @map("driver_name")
  driverNationality String?   @map("driver_nationality")
  phone             String?   @map("ip_address")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  ordreMission OrdreMission? @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)

  @@map("transports")
}

model Conteneur {
  id                Int       @id @default(autoincrement())
  ordreMissionId    Int?      @map("ordre_mission_id")
  numConteneur      String    @map("num_conteneur")
  driverName        String?   @map("driver_name")
  driverNationality String?   @map("driver_nationality")
  phone             String?   @map("ip_address")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  ordreMission OrdreMission? @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)

  @@map("conteneurs")
}

model Voiture {
  id                Int       @id @default(autoincrement())
  ordreMissionId    Int?      @map("ordre_mission_id")
  chassis           String    @map("chassis")
  driverName        String?   @map("driver_name")
  driverNationality String?   @map("driver_nationality")
  phone             String?   @map("ip_address")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  ordreMission OrdreMission? @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)

  @@map("voitures")
}

model AuditLog {
  id          Int         @id @default(autoincrement())
  tableName   String?     @map("table_name") @db.VarChar(100)
  Description String?
  action      AuditAction
  oldValues   Json?       @map("old_values")
  newValues   Json?       @map("new_values")
  userId      Int?        @map("user_id")
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent") @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_log")
}
