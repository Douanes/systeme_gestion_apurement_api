generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Pooler for app runtime
  directUrl = env("DIRECT_URL") // Direct connection for migrations
}

enum UserRole {
  ADMIN
  AGENT
  SUPERVISEUR
  TRANSITAIRE
  DECLARANT
}

enum StatutApurement {
  APURE_SE
  APURE
  NON_APURE
  REJET
}

enum StatutOrdreMission {
  EN_COURS
  DEPOSE
  TRAITE
  COTATION
  REJETE
  ANNULE
}

enum TypeNotification {
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum RequestStatus {
  EN_ATTENTE
  EN_REVISION
  APPROUVE
  REJETE
  EXPIRE
  ANNULE
}

enum DocumentType {
  REGISTRE_COMMERCE
  NINEA
  CARTE_PROFESSIONNELLE
  AUTRE
}

model User {
  id              Int       @id @default(autoincrement())
  username        String    @unique @db.VarChar(100)
  email           String    @unique @db.VarChar(255)
  passwordHash    String?   @map("password_hash") // Nullable pour permettre activation par token
  firstname       String    @map("first_name")
  lastname        String    @map("last_name")
  phone           String?
  role            UserRole
  isActive        Boolean   @default(false) @map("is_active")
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastLogin       DateTime? @map("last_login")
  deletedAt       DateTime? @map("deleted_at")

  declarations          Declaration[]
  colis                 Colis[]
  maisonTransitsOwned   MaisonTransit[]          @relation("MaisonTransitResponsable") // Garde pour compatibilité avec responsableId
  maisonTransits        UserMaisonTransit[] // Nouvelle relation Many-to-Many
  ordreMissions         OrdreMission[]
  auditLogs             AuditLog[]
  emailVerifications    EmailVerification[]
  activationTokens      AccountActivationToken[] // Tokens d'activation
  passwordResetTokens   PasswordResetToken[] // Tokens de réinitialisation de mot de passe
  agent                 Agent?
  userPermissions       UserPermission[] // Permissions personnalisées
  maisonTransitRequests MaisonTransitRequest[]   @relation("RequestCreator")
  reviewedRequests      MaisonTransitRequest[]   @relation("RequestReviewer")

  @@map("users")
}

model Regime {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  nbreNatureMarchandise Int?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  deletedAt DateTime?

  declarations Declaration[]

  @@map("regimes")
}

model Escouade {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  description     String?   @db.Text
  operationalDate DateTime?
  chefId          Int?
  adjointId       Int?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  chef           Agent?           @relation("EscouadeChef", fields: [chefId], references: [id])
  adjoint        Agent?           @relation("EscouadeAdjoint", fields: [adjointId], references: [id])
  escouadeAgents EscouadeAgents[]
  agent          Agent?           @relation(fields: [agentId], references: [id])
  agentId        Int?
  ordreMissions  OrdreMission[]

  @@map("escouades")
}

model Agent {
  id         Int       @id @default(autoincrement())
  userId     Int?      @unique @map("user_id")
  matricule  String?   @unique
  grade      String?
  firstname  String    @map("first_name")
  lastname   String    @map("last_name")
  phone      String?
  email      String?
  affectedAt DateTime? @map("affected_at")
  officeId   Int?      @map("office_id")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user               User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  bureauAffectation  BureauSortie?    @relation(fields: [officeId], references: [id], onDelete: SetNull)
  declarations       Declaration[]
  escouadesAsChef    Escouade[]       @relation("EscouadeChef")
  escouadesAsAdjoint Escouade[]       @relation("EscouadeAdjoint")
  escouadeAgents     EscouadeAgents[]
  ordreMissions      OrdreMission[]
  escouades          Escouade[]

  @@map("agents")
}

model EscouadeAgents {
  escouadeId Int
  agentId    Int

  escouade Escouade @relation(fields: [escouadeId], references: [id])
  agent    Agent    @relation(fields: [agentId], references: [id])

  @@id([escouadeId, agentId])
  @@map("escouade_agents")
}

model BureauSortie {
  id            Int       @id @default(autoincrement())
  code          String    @unique
  name          String
  localisation  String?
  paysFrontiere String?   @map("pays_frontiere")
  itineraire    String? // Itinéraire par défaut pour ce bureau de sortie
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  declarations  Declaration[]
  agents        Agent[]
  ordreMissions OrdreMission[]

  @@map("bureaux_sorties")
}

model MaisonTransit {
  id            Int       @id @default(autoincrement())
  code          String    @unique
  name          String
  address       String?   @db.Text
  phone         String?
  email         String?
  responsableId Int?      @map("responsable_id")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  responsable   User?                    @relation("MaisonTransitResponsable", fields: [responsableId], references: [id])
  users         UserMaisonTransit[] // Nouvelle relation Many-to-Many
  invitations   AccountActivationToken[] // Invitations pour staff
  depositaires  Depositaire[]
  declarations  Declaration[]
  ordreMissions OrdreMission[]

  @@map("maisons_transits")
}

model OrdreMission {
  id               Int                @id @default(autoincrement())
  number           String             @unique @map("number") @db.VarChar(50)
  destination      String?
  itineraire       String?            @db.Text
  dateOrdre        DateTime?          @map("date_ordre")
  depositaireId    Int?               @map("depositaire_id")
  maisonTransitId  Int?               @map("maison_transit_id")
  createdById      Int?               @map("created_by")
  statut           StatutOrdreMission @default(EN_COURS)
  statutApurement  StatutApurement    @default(NON_APURE) @map("statut_apurement")
  ecouadeId        Int?               @map("escouade_id")
  agentEscorteurId Int?               @map("agent_escorteur_id")
  bureauSortieId   Int?               @map("bureau_sortie_id")
  observations     String?            @db.Text
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  deletedAt        DateTime?          @map("deleted_at")

  depositaire    Depositaire?              @relation(fields: [depositaireId], references: [id], onDelete: SetNull)
  createdBy      User?                     @relation(fields: [createdById], references: [id])
  agentEscorteur Agent?                    @relation(fields: [agentEscorteurId], references: [id], onDelete: SetNull)
  bureauSortie   BureauSortie?             @relation(fields: [bureauSortieId], references: [id], onDelete: SetNull)
  maisonTransit  MaisonTransit?            @relation(fields: [maisonTransitId], references: [id], onDelete: SetNull)
  ecouade        Escouade?                 @relation(fields: [ecouadeId], references: [id], onDelete: SetNull)
  declarations   OrdreMissionDeclaration[]
  camions        Camion[]
  conteneurs     Conteneur[]
  voitures       Voiture[]

  @@map("ordres_missions")
}

model OrdreMissionDeclaration {
  id             Int @id @default(autoincrement())
  ordreMissionId Int @map("ordre_mission_id")
  declarationId  Int @map("declaration_id")

  // Quantités pour cette parcelle spécifique
  nbreColisParcelle Int     @map("nbre_colis_parcelle")
  poidsParcelle     Decimal @map("poids_parcelle") @db.Decimal(12, 2)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  ordreMission OrdreMission @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)
  declaration  Declaration  @relation(fields: [declarationId], references: [id], onDelete: Cascade)

  @@unique([ordreMissionId, declarationId])
  @@map("ordre_mission_declarations")
}

model Depositaire {
  id                   Int       @id @default(autoincrement())
  name                 String
  phone1               String    @db.VarChar(20)
  phone2               String?
  address              String?   @db.Text
  email                String?
  identificationNumber String?   @map("identification_number")
  isActive             Boolean   @default(true) @map("is_active")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")

  savedDeclarations Declaration[]
  maisonTransit     MaisonTransit? @relation(fields: [maisonTransitId], references: [id])
  maisonTransitId   Int?
  ordreMissions     OrdreMission[]

  @@map("depositaires")
}

model Declaration {
  id                Int      @id @default(autoincrement())
  numeroDeclaration String   @map("numero_declaration") @db.VarChar(50)
  dateDeclaration   DateTime @map("date_declaration") @db.Date
  regimeId          Int?     @map("regime_id")

  // Totaux de la déclaration originale
  nbreColisTotal Int     @map("nbre_colis_total")
  poidsTotal     Decimal @map("poids_total") @db.Decimal(12, 2)

  // Reste à livrer (mis à jour après chaque parcelle)
  nbreColisRestant Int     @default(0) @map("nbre_colis_restant")
  poidsRestant     Decimal @default(0) @map("poids_restant") @db.Decimal(12, 2)

  statutApurement StatutApurement? @default(NON_APURE) @map("statut_apurement")
  dateApurement   DateTime?        @map("date_apurement") @db.Date
  motifRejet      String?          @map("motif_rejet") @db.Text
  bureauSortieId  Int?
  maisonTransitId Int?
  depositaireId   Int?

  createdById Int?      @map("created_by")
  updatedById Int?      @map("updated_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  ordreMissions OrdreMissionDeclaration[]
  createdBy     User?                     @relation(fields: [createdById], references: [id], onDelete: SetNull)
  bureauSortie  BureauSortie?             @relation(fields: [bureauSortieId], references: [id])
  maisonTransit MaisonTransit?            @relation(fields: [maisonTransitId], references: [id])
  depositaire   Depositaire?              @relation(fields: [depositaireId], references: [id])
  regime        Regime?                   @relation(fields: [regimeId], references: [id])
  agent         Agent?                    @relation(fields: [agentId], references: [id])
  agentId       Int?
  colis         Colis[]

  @@map("declarations")
}

model Colis {
  id                Int      @id @default(autoincrement())
  declarationId     Int?     @map("declaration_id")
  natureMarchandise String   @map("nature_marchandise") @db.Text
  positionTarifaire Int?     @map("position_tarifaire")
  nbreColis         Int?     @map("nbre_colis")
  poids             Decimal? @map("poids") @db.Decimal(12, 2)
  valeurDeclaree    Decimal? @map("valeur_declaree") @db.Decimal(15, 2)

  createdById Int?      @map("created_by")
  updatedById Int?      @map("updated_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  declaration Declaration? @relation(fields: [declarationId], references: [id], onDelete: Cascade)
  createdBy   User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@map("colis")
}

model Camion {
  id                Int       @id @default(autoincrement())
  ordreMissionId    Int?      @map("ordre_mission_id")
  immatriculation   String    @unique
  driverName        String?   @map("driver_name")
  driverNationality String?   @map("driver_nationality")
  phone             String?   @map("ip_address")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  ordreMission OrdreMission? @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)

  @@map("transports")
}

model Conteneur {
  id                Int       @id @default(autoincrement())
  ordreMissionId    Int?      @map("ordre_mission_id")
  numConteneur      String    @unique @map("num_conteneur")
  numPlomb      String?    @map("num_plomb")
  driverName        String?   @map("driver_name")
  driverNationality String?   @map("driver_nationality")
  phone             String?   @map("ip_address")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  ordreMission OrdreMission? @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)

  @@map("conteneurs")
}

model Voiture {
  id                Int       @id @default(autoincrement())
  ordreMissionId    Int?      @map("ordre_mission_id")
  chassis           String    @unique @map("chassis")
  driverName        String?   @map("driver_name")
  driverNationality String?   @map("driver_nationality")
  phone             String?   @map("ip_address")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  ordreMission OrdreMission? @relation(fields: [ordreMissionId], references: [id], onDelete: Cascade)

  @@map("voitures")
}

model AuditLog {
  id          Int         @id @default(autoincrement())
  tableName   String?     @map("table_name") @db.VarChar(100)
  Description String?
  action      AuditAction
  oldValues   Json?       @map("old_values")
  newValues   Json?       @map("new_values")
  userId      Int?        @map("user_id")
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent") @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_log")
}

model EmailVerification {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  token      String    @unique @db.VarChar(255)
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  verifiedAt DateTime? @map("verified_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("email_verifications")
}

model UserMaisonTransit {
  userId          Int
  maisonTransitId Int
  role            String?   @db.VarChar(50) // "RESPONSABLE", "STAFF", "MANAGER"
  assignedAt      DateTime  @default(now()) @map("assigned_at")
  assignedBy      Int?      @map("assigned_by")
  deletedAt       DateTime? @map("deleted_at")

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  maisonTransit MaisonTransit @relation(fields: [maisonTransitId], references: [id], onDelete: Cascade)

  @@id([userId, maisonTransitId])
  @@index([userId])
  @@index([maisonTransitId])
  @@map("user_maison_transit")
}

model AccountActivationToken {
  id              Int       @id @default(autoincrement())
  userId          Int?      @map("user_id")
  email           String    @db.VarChar(255)
  token           String    @unique @db.VarChar(255)
  type            String    @db.VarChar(50) // 'AGENT_ACTIVATION', 'MT_INVITATION'
  expiresAt       DateTime  @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  usedAt          DateTime? @map("used_at")
  maisonTransitId Int?      @map("maison_transit_id")
  invitedBy       Int?      @map("invited_by")
  staffRole       String?   @map("staff_role") @db.VarChar(50) // 'STAFF', 'MANAGER'

  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  maisonTransit MaisonTransit? @relation(fields: [maisonTransitId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([email])
  @@map("account_activation_tokens")
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model Permission {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100) // Ex: "declarations.create"
  resource    String    @db.VarChar(50) // Ex: "declarations"
  action      String    @db.VarChar(50) // Ex: "create", "read", "update", "delete"
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([name])
  @@map("permissions")
}

model RolePermission {
  id           Int       @id @default(autoincrement())
  role         UserRole
  permissionId Int       @map("permission_id")
  granted      Boolean   @default(true) // true = accordé, false = révoqué
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserPermission {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  permissionId Int       @map("permission_id")
  granted      Boolean // true = accordé explicitement, false = révoqué explicitement
  grantedBy    Int?      @map("granted_by") // ID de l'admin qui a accordé la permission
  grantedAt    DateTime  @default(now()) @map("granted_at")
  expiresAt    DateTime? @map("expires_at") // Permission temporaire
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([expiresAt])
  @@map("user_permissions")
}

model MaisonTransitRequest {
  id               Int           @id @default(autoincrement())
  email            String        @db.VarChar(255)
  companyName      String        @map("company_name") @db.VarChar(255)
  phone            String?       @db.VarChar(20)
  address          String?       @db.Text
  ninea            String?       @db.VarChar(100)
  registreCommerce String?       @map("registre_commerce") @db.VarChar(100)
  status           RequestStatus @default(EN_ATTENTE)
  invitationToken  String        @unique @map("invitation_token") @db.VarChar(255)
  tokenExpiresAt   DateTime      @map("token_expires_at")
  invitedById      Int           @map("invited_by") // Admin ou Agent qui a invité
  reviewedById     Int?          @map("reviewed_by") // Admin qui a validé/rejeté
  reviewedAt       DateTime?     @map("reviewed_at")
  rejectionReason  String?       @map("rejection_reason") @db.Text
  activatedAt      DateTime?     @map("activated_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  deletedAt        DateTime?     @map("deleted_at")

  invitedBy  User              @relation("RequestCreator", fields: [invitedById], references: [id], onDelete: Restrict)
  reviewedBy User?             @relation("RequestReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  documents  RequestDocument[]

  @@index([email])
  @@index([invitationToken])
  @@index([status])
  @@index([invitedById])
  @@map("maison_transit_requests")
}

model RequestDocument {
  id           Int          @id @default(autoincrement())
  requestId    Int          @map("request_id")
  type         DocumentType
  fileName     String       @map("file_name") @db.VarChar(255)
  fileUrl      String       @map("file_url") @db.Text
  fileSize     Int?         @map("file_size") // En bytes
  mimeType     String?      @map("mime_type") @db.VarChar(100)
  cloudinaryId String?      @map("cloudinary_id") @db.VarChar(255) // Pour pouvoir supprimer le fichier si besoin
  uploadedAt   DateTime     @default(now()) @map("uploaded_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  deletedAt    DateTime?    @map("deleted_at")

  request MaisonTransitRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([type])
  @@map("request_documents")
}
